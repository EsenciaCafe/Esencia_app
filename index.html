<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pedido Esencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; overscroll-behavior: none; }
    body{ margin:0; background:#f5f5f5; color:#111827; }

    .app{
      max-width: 860px;
      margin: 0 auto;
      padding: 0.9rem 0.8rem 6.4rem; /* deja espacio para la barra inferior */
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:0.8rem;
      margin-bottom: 0.7rem;
    }
    h1{ margin:0; font-size:1.25rem; font-weight:800; }
    .sub{ margin:0.25rem 0 0; font-size:0.82rem; color:#6b7280; }

    .top-actions{
      display:flex; gap:0.4rem; flex-wrap:wrap; justify-content:flex-end;
    }

    button{
      border:0;
      border-radius:999px;
      padding:0.45rem 0.75rem;
      font-size:0.85rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:0.35rem;
      white-space:nowrap;
      transition: transform .05s ease, background .1s ease;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }

    .btn-primary{ background:#111827; color:#fff; }
    .btn-secondary{ background:#e5e7eb; color:#111827; }
    .btn-ghost{ background:transparent; color:#6b7280; padding-inline:0.45rem; }
    .btn-danger{ background:#fee2e2; color:#b91c1c; }

    .card{
      background:#fff;
      border:1px solid #ececec;
      border-radius:16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.04);
      padding:0.8rem;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap:0.6rem;
      margin-bottom:0.8rem;
    }

    .search{
      display:flex;
      gap:0.5rem;
      align-items:center;
    }
    .search input{
      width:100%;
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:0.55rem 0.8rem;
      font-size:0.92rem;
      outline:none;
      background:#fff;
    }
    .search input:focus{ border-color:#111827; }

    .filters{
      display:flex;
      gap:0.4rem;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .chips{ display:flex; gap:0.4rem; flex-wrap:wrap; }
    .chip{
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#374151;
      border-radius:999px;
      padding:0.3rem 0.65rem;
      font-size:0.78rem;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color:#111827;
      background:#111827;
      color:#fff;
    }

    .summary{
      font-size:0.78rem;
      color:#6b7280;
      display:flex;
      gap:0.35rem;
      align-items:center;
      justify-content:flex-end;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background:#22c55e;
    }
    .dot.warn{ background:#f97316; }

    /* Lista scrollable SOLO dentro del contenedor */
    .list{
      height: 62vh;
      max-height: 62vh;
      overflow-y:auto;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
      display:flex;
      flex-direction:column;
      gap:0.6rem;
      padding-right: 2px; /* para que no ‚Äúcorte‚Äù el scroll bar */
    }

    .empty{
      color:#9ca3af;
      font-size:0.9rem;
      text-align:center;
      padding:1rem 0.5rem;
    }

    .item{
      border:1px solid #f1f1f1;
      border-radius:16px;
      padding:0.7rem 0.7rem 0.65rem;
      background:#fff;
    }
    .item.pending{
      background:#fff7ed;
      border-color:#fed7aa;
    }

    .row1{
      display:flex;
      gap:0.6rem;
      justify-content:space-between;
      align-items:flex-start;
    }

    .name-wrap{
      flex:1;
      min-width:0;
    }
    .name{
      width:100%;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:0.5rem 0.65rem;
      font-size:0.95rem;
      font-weight:700;
      line-height:1.2;
      outline:none;
      resize:none;
      overflow:hidden; /* sin scroll interno */
      background:#fff;
    }
    .name:focus{ border-color:#111827; }

    .unit{
      margin-top:0.4rem;
      width:100%;
      border:1px solid #e5e7eb;
      border-radius:999px;
      padding:0.45rem 0.65rem;
      font-size:0.85rem;
      outline:none;
      background:#fff;
    }
    .unit:focus{ border-color:#111827; }

    .right{
      display:flex;
      flex-direction:column;
      gap:0.45rem;
      align-items:flex-end;
      flex-shrink:0;
      min-width: 170px;
    }

    .nums{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:0.45rem;
      width:100%;
    }

    .num{
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:0.45rem 0.55rem;
      background:#fff;
    }
    .num label{
      display:block;
      font-size:0.68rem;
      color:#6b7280;
      margin-bottom:0.15rem;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    .num input{
      width:100%;
      border:0;
      outline:none;
      font-size:1rem;
      font-weight:700;
      background:transparent;
      padding:0;
    }

    .statusline{
      margin-top:0.55rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.6rem;
    }

    .badges{
      display:flex;
      gap:0.35rem;
      flex-wrap:wrap;
      align-items:center;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:0.25rem;
      padding:0.15rem 0.55rem;
      border-radius:999px;
      font-size:0.74rem;
      font-weight:600;
      white-space:nowrap;
    }
    .b-pending{ background:#fee2e2; color:#b91c1c; }
    .b-ok{ background:#ecfdf5; color:#166534; }
    .b-buy{ background:#fef3c7; color:#92400e; }
    .b-nomax{ background:#e5e7eb; color:#374151; }

    .mini-actions{
      display:flex;
      gap:0.25rem;
      align-items:center;
      justify-content:flex-end;
    }
    .icon{
      border-radius:12px;
      padding:0.35rem 0.5rem;
      font-size:0.9rem;
      background:#f3f4f6;
      color:#111827;
    }
    .icon:disabled{ opacity:0.4; cursor:not-allowed; }

    /* Barra inferior fija */
    .bottom-bar{
      position: fixed;
      left:0; right:0; bottom:0;
      background: rgba(245,245,245,0.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid #e5e7eb;
      padding: 0.6rem 0.7rem;
    }
    .bottom-inner{
      max-width:860px;
      margin:0 auto;
      display:flex;
      gap:0.5rem;
      align-items:center;
      justify-content:space-between;
    }
    .bottom-left{
      font-size:0.78rem;
      color:#6b7280;
      display:flex;
      gap:0.45rem;
      align-items:center;
      min-width:0;
    }
    .bottom-left strong{ color:#111827; font-weight:800; }
    .bottom-right{ display:flex; gap:0.45rem; }

    /* Modal simple */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 0.8rem;
      z-index: 50;
    }
    .modal{
      width: min(860px, 100%);
      background:#fff;
      border-radius:16px;
      border:1px solid #ececec;
      box-shadow: 0 12px 40px rgba(0,0,0,0.18);
      padding:0.8rem;
    }
    .modal h2{
      margin:0;
      font-size:1rem;
      font-weight:800;
    }
    .modal p{
      margin:0.35rem 0 0.65rem;
      font-size:0.85rem;
      color:#6b7280;
    }
    .modal textarea{
      width:100%;
      min-height: 180px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:0.6rem 0.7rem;
      font-size:0.85rem;
      outline:none;
      resize: vertical;
    }
    .modal textarea:focus{ border-color:#111827; }
    .modal-actions{
      display:flex;
      gap:0.5rem;
      justify-content:flex-end;
      margin-top:0.6rem;
      flex-wrap:wrap;
    }

    @media (min-width: 720px){
      h1{ font-size:1.45rem; }
      .controls{ grid-template-columns: 1fr auto; align-items:center; }
      .filters{ justify-content:flex-start; }
      .summary{ justify-content:flex-end; }
      .right{ min-width: 220px; }
      .list{ height: 58vh; max-height: 58vh; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div>
        <h1>Pedido Esencia</h1>
        <p class="sub">Revisa stocks y genera el texto para enviarlo a compras.</p>
      </div>
      <div class="top-actions">
        <button class="btn-secondary" id="btn-add">‚ûï A√±adir</button>
        <button class="btn-ghost" id="btn-reset" title="Borra productos en este dispositivo">üóë</button>
        <button class="btn-ghost" id="btn-export" title="Copia tu configuraci√≥n">üíæ</button>
        <button class="btn-ghost" id="btn-import" title="Pega una configuraci√≥n">üìÇ</button>
      </div>
    </header>

    <div class="card">
      <div class="controls">
        <div class="search">
          <input id="search" type="text" placeholder="Buscar‚Ä¶ (ej: monin, leche, vasos)" />
        </div>

        <div class="filters">
          <div class="chips" id="chips">
            <span class="chip active" data-filter="all">Todos</span>
            <span class="chip" data-filter="pending">Pendientes</span>
            <span class="chip" data-filter="buy">Pedir</span>
          </div>
          <div class="summary" id="summary">
            <span class="dot warn"></span>
            <span><strong>0</strong> pendientes</span>
            <span>¬∑</span>
            <span><strong>0</strong> productos</span>
          </div>
        </div>
      </div>

      <div class="list" id="list"></div>
      <div class="empty" id="empty" style="display:none;">No hay productos. Pulsa ‚ÄúA√±adir‚Äù.</div>
    </div>
  </div>

  <!-- Modal texto pedido -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2>Texto de pedido</h2>
      <p>Se genera con lo que falta para llegar al stock m√°ximo.</p>
      <textarea id="pedidoText"></textarea>
      <div class="modal-actions">
        <button class="btn-secondary" id="btn-copy">üìã Copiar</button>
        <button class="btn-ghost" id="btn-close">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Barra inferior fija -->
  <div class="bottom-bar">
    <div class="bottom-inner">
      <div class="bottom-left" id="bottomInfo">
        <span class="dot warn"></span>
        <span><strong id="revCount">0</strong>/<strong id="totalCount">0</strong> revisados</span>
        <span>¬∑</span>
        <span><strong id="buyCount">0</strong> para pedir</span>
      </div>
      <div class="bottom-right">
        <button class="btn-secondary" id="btn-newSession" title="Vuelve a marcar todo como pendiente">üîÅ</button>
        <button class="btn-primary" id="btn-generate">üßÆ Pedido</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Config ======
    const STORAGE_KEY = "esencia-pedido-mobile-v1";

    // Datos iniciales (solo ejemplo)
    const DEFAULT_PRODUCTS = [
      { id: crypto.randomUUID?.() ?? String(Date.now())+"-1", nombre: "Sirope Monin Pistacho", unidad: "botella", stockActual: 0, stockMax: 1 },
      { id: crypto.randomUUID?.() ?? String(Date.now())+"-2", nombre: "Sirope Monin Vainilla", unidad: "botella", stockActual: 1, stockMax: 1 },
      { id: crypto.randomUUID?.() ?? String(Date.now())+"-3", nombre: "Leche entera", unidad: "caja 12 u", stockActual: 1, stockMax: 3 },
    ];

    let products = [];
    let sessionTouched = new Set(); // al abrir: todo pendiente
    let currentFilter = "all";
    let searchQuery = "";

    // ====== Helpers ======
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw){
          products = DEFAULT_PRODUCTS;
          save();
        } else {
          const parsed = JSON.parse(raw);
          products = Array.isArray(parsed) ? parsed : DEFAULT_PRODUCTS;
        }
      }catch{
        products = DEFAULT_PRODUCTS;
      }
      sessionTouched = new Set();
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
      updateCounters();
    }

    function clampNum(v){
      const n = Number(v);
      if (Number.isFinite(n) && n >= 0) return n;
      return 0;
    }

    function autoGrow(el){
      el.style.height = "auto";
      el.style.height = el.scrollHeight + "px";
    }

    function needsBuy(p){
      const max = clampNum(p.stockMax);
      const cur = clampNum(p.stockActual);
      if(max <= 0) return false;
      return (max - cur) > 0;
    }

    function visibleProducts(){
      const q = searchQuery.trim().toLowerCase();
      return products
        .map((p, idx) => ({p, idx}))
        .filter(({p}) => {
          const inSearch = !q || (p.nombre || "").toLowerCase().includes(q) || (p.unidad || "").toLowerCase().includes(q);
          if(!inSearch) return false;

          if(currentFilter === "pending") return !sessionTouched.has(p.id);
          if(currentFilter === "buy") return needsBuy(p);
          return true;
        });
    }

    // ====== UI ======
    const listEl = document.getElementById("list");
    const emptyEl = document.getElementById("empty");

    function render(){
      const items = visibleProducts();
      listEl.innerHTML = "";

      if(products.length === 0){
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = items.length === 0 ? "block" : "none";
      if(items.length === 0){
        emptyEl.textContent = "No hay coincidencias con tu b√∫squeda/filtro.";
        return;
      } else {
        emptyEl.textContent = "No hay productos. Pulsa ‚ÄúA√±adir‚Äù.";
      }

      items.forEach(({p, idx}) => {
        const isPending = !sessionTouched.has(p.id);

        const card = document.createElement("div");
        card.className = "item" + (isPending ? " pending" : "");

        // Row 1
        const row1 = document.createElement("div");
        row1.className = "row1";

        const nameWrap = document.createElement("div");
        nameWrap.className = "name-wrap";

        const name = document.createElement("textarea");
        name.className = "name";
        name.rows = 1;
        name.placeholder = "Nombre del art√≠culo";
        name.value = p.nombre || "";
        name.addEventListener("input", () => {
          p.nombre = name.value;
          autoGrow(name);
          save();
        });
        requestAnimationFrame(() => autoGrow(name));

        const unit = document.createElement("input");
        unit.className = "unit";
        unit.type = "text";
        unit.placeholder = "Unidad (opcional) ¬∑ ej: botella, caja 12u, kg‚Ä¶";
        unit.value = p.unidad || "";
        unit.addEventListener("input", () => {
          p.unidad = unit.value;
          save();
        });

        nameWrap.appendChild(name);
        nameWrap.appendChild(unit);

        const right = document.createElement("div");
        right.className = "right";

        const nums = document.createElement("div");
        nums.className = "nums";

        const numA = document.createElement("div");
        numA.className = "num";
        numA.innerHTML = `<label>Actual</label>`;
        const inA = document.createElement("input");
        inA.type = "number";
        inA.inputMode = "numeric";
        inA.min = "0";
        inA.value = (p.stockActual ?? 0);
        inA.addEventListener("input", () => {
          p.stockActual = clampNum(inA.value);
          sessionTouched.add(p.id);
          save();
          render(); // para refrescar badges y estado pending
        });
        numA.appendChild(inA);

        const numM = document.createElement("div");
        numM.className = "num";
        numM.innerHTML = `<label>M√°ximo</label>`;
        const inM = document.createElement("input");
        inM.type = "number";
        inM.inputMode = "numeric";
        inM.min = "0";
        inM.value = (p.stockMax ?? 0);
        inM.addEventListener("input", () => {
          p.stockMax = clampNum(inM.value);
          save();
          render();
        });
        numM.appendChild(inM);

        nums.appendChild(numA);
        nums.appendChild(numM);
        right.appendChild(nums);

        row1.appendChild(nameWrap);
        row1.appendChild(right);

        // Status line
        const status = document.createElement("div");
        status.className = "statusline";

        const badges = document.createElement("div");
        badges.className = "badges";

        if(!p.stockMax || clampNum(p.stockMax) <= 0){
          const b = document.createElement("span");
          b.className = "badge b-nomax";
          b.textContent = "Sin m√°ximo";
          badges.appendChild(b);
        } else if(needsBuy(p)){
          const falta = Math.max(0, clampNum(p.stockMax) - clampNum(p.stockActual));
          const b = document.createElement("span");
          b.className = "badge b-buy";
          b.textContent = `Pedir: ${falta}`;
          badges.appendChild(b);
        } else {
          const b = document.createElement("span");
          b.className = "badge b-ok";
          b.textContent = "OK";
          badges.appendChild(b);
        }

        if(isPending){
          const b2 = document.createElement("span");
          b2.className = "badge b-pending";
          b2.textContent = "Pendiente";
          badges.appendChild(b2);
        }

        const acts = document.createElement("div");
        acts.className = "mini-actions";

        const up = document.createElement("button");
        up.className = "icon";
        up.textContent = "‚¨ÜÔ∏è";
        up.title = "Subir";
        up.disabled = idx === 0;
        up.addEventListener("click", () => {
          const tmp = products[idx-1];
          products[idx-1] = products[idx];
          products[idx] = tmp;
          save();
          render();
        });

        const down = document.createElement("button");
        down.className = "icon";
        down.textContent = "‚¨áÔ∏è";
        down.title = "Bajar";
        down.disabled = idx === products.length - 1;
        down.addEventListener("click", () => {
          const tmp = products[idx+1];
          products[idx+1] = products[idx];
          products[idx] = tmp;
          save();
          render();
        });

        const del = document.createElement("button");
        del.className = "icon";
        del.textContent = "üóë";
        del.title = "Eliminar";
        del.addEventListener("click", () => {
          if(!confirm(`Eliminar "${p.nombre || "producto"}"?`)) return;
          products = products.filter(x => x.id !== p.id);
          save();
          render();
        });

        acts.appendChild(up);
        acts.appendChild(down);
        acts.appendChild(del);

        status.appendChild(badges);
        status.appendChild(acts);

        card.appendChild(row1);
        card.appendChild(status);

        listEl.appendChild(card);
      });

      updateCounters();
    }

    function updateCounters(){
      const total = products.length;
      const pendientes = products.filter(p => !sessionTouched.has(p.id)).length;
      const revisados = total - pendientes;
      const buy = products.filter(p => needsBuy(p)).length;

      // summary top right
      const summary = document.getElementById("summary");
      summary.innerHTML = `
        <span class="dot ${pendientes>0 ? "warn":""}"></span>
        <span><strong>${pendientes}</strong> pendientes</span>
        <span>¬∑</span>
        <span><strong>${total}</strong> productos</span>
      `;

      // bottom bar
      document.getElementById("revCount").textContent = String(revisados);
      document.getElementById("totalCount").textContent = String(total);
      document.getElementById("buyCount").textContent = String(buy);
      const dot = document.querySelector("#bottomInfo .dot");
      if (pendientes>0) dot.classList.add("warn"); else dot.classList.remove("warn");
    }

    // ====== Pedido ======
    const modalBackdrop = document.getElementById("modalBackdrop");
    const pedidoText = document.getElementById("pedidoText");

    function buildPedidoText(){
      const lines = [];
      products.forEach(p => {
        if(!p.nombre) return;
        const max = clampNum(p.stockMax);
        const cur = clampNum(p.stockActual);
        if(max <= 0) return;
        const falta = Math.max(0, max - cur);
        if(falta <= 0) return;

        const unit = (p.unidad || "").trim();
        const tail = unit ? ` ${unit}` : "";
        lines.push(`- ${p.nombre.trim()} ‚Äî ${falta}${tail}`);
      });

      if(lines.length === 0){
        return "Con el stock actual no hace falta comprar nada üôå";
      }

      return "Hola, te paso el pedido de Esencia:\n\n" + lines.join("\n") + "\n\nGracias üôå";
    }

    function openModal(){
      pedidoText.value = buildPedidoText();
      modalBackdrop.style.display = "flex";
      pedidoText.focus();
      pedidoText.setSelectionRange(0,0);
    }

    function closeModal(){
      modalBackdrop.style.display = "none";
    }

    async function copyPedido(){
      const txt = (pedidoText.value || "").trim();
      if(!txt) return;
      try{
        await navigator.clipboard.writeText(txt);
        alert("Texto copiado ‚úÖ");
      }catch{
        pedidoText.select();
        document.execCommand("copy");
        alert("Texto copiado ‚úÖ");
      }
    }

    // ====== Export/Import ======
    async function exportConfig(){
      const data = JSON.stringify(products, null, 2);
      try{
        await navigator.clipboard.writeText(data);
        alert("Config copiada ‚úÖ\nP√©gala en el otro dispositivo y usa üìÇ para cargar.");
      }catch{
        alert("No se pudo copiar. Aqu√≠ tienes el JSON:\n\n" + data);
      }
    }

    function importConfig(){
      const raw = prompt("Pega aqu√≠ la configuraci√≥n (JSON):");
      if(!raw) return;
      try{
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return alert("Formato inv√°lido.");
        products = parsed.map(x => ({
          id: x.id || (crypto.randomUUID?.() ?? String(Date.now())+"-"+Math.random()),
          nombre: x.nombre || "",
          unidad: x.unidad || "",
          stockActual: clampNum(x.stockActual ?? 0),
          stockMax: clampNum(x.stockMax ?? 0),
        }));
        sessionTouched = new Set();
        save();
        render();
        alert("Config cargada ‚úÖ");
      }catch{
        alert("JSON inv√°lido o incompleto.");
      }
    }

    // ====== Session reset ======
    function newSession(){
      sessionTouched = new Set();
      updateCounters();
      render();
    }

    // ====== Add / Reset ======
    function addProduct(){
      products.push({
        id: crypto.randomUUID?.() ?? String(Date.now()) + "-" + Math.random(),
        nombre: "",
        unidad: "",
        stockActual: 0,
        stockMax: 0
      });
      save();
      render();
      // lleva el scroll arriba para ver el nuevo (al final, pero no te rompe)
      const list = document.getElementById("list");
      list.scrollTo({top: list.scrollHeight, behavior:"smooth"});
    }

    function resetAll(){
      if(!confirm("Esto borra TODOS los productos guardados en este dispositivo. ¬øSeguro?")) return;
      products = [];
      sessionTouched = new Set();
      save();
      render();
    }

    // ====== Filters / Search ======
    function setFilter(f){
      currentFilter = f;
      document.querySelectorAll(".chip").forEach(c => {
        c.classList.toggle("active", c.dataset.filter === f);
      });
      render();
    }

    // ====== Init ======
    document.addEventListener("DOMContentLoaded", () => {
      load();
      render();

      document.getElementById("btn-add").addEventListener("click", addProduct);
      document.getElementById("btn-reset").addEventListener("click", resetAll);
      document.getElementById("btn-export").addEventListener("click", exportConfig);
      document.getElementById("btn-import").addEventListener("click", importConfig);

      document.getElementById("btn-generate").addEventListener("click", openModal);
      document.getElementById("btn-newSession").addEventListener("click", newSession);

      document.getElementById("btn-close").addEventListener("click", closeModal);
      document.getElementById("btn-copy").addEventListener("click", copyPedido);

      modalBackdrop.addEventListener("click", (e) => {
        if(e.target === modalBackdrop) closeModal();
      });

      document.getElementById("chips").addEventListener("click", (e) => {
        const chip = e.target.closest(".chip");
        if(!chip) return;
        setFilter(chip.dataset.filter);
      });

      const search = document.getElementById("search");
      search.addEventListener("input", () => {
        searchQuery = search.value || "";
        render();
      });
    });
  </script>
</body>
</html>

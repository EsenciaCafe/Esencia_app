<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pedido Esencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light;
    }
    * { box-sizing: border-box; }

    body { margin: 0; background: #f5f5f5; color: #222; }
    .app { max-width: 980px; margin: 0 auto; padding: 1.5rem 1rem 2.5rem; }
    header { margin-bottom: 1.5rem; }
    h1 { margin: 0; font-size: 1.6rem; font-weight: 700; }
    .subtitle { margin-top: 0.35rem; font-size: 0.9rem; color: #666; }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.04);
      border: 1px solid #ececec;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.8rem;
    }
    .toolbar-left, .toolbar-right { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }

    button {
      border-radius: 999px;
      border: none;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s ease;
    }
    button:active { transform: translateY(1px); box-shadow: none; }
    .btn-primary { background: #111827; color: #fff; box-shadow: 0 6px 18px rgba(0,0,0,0.18); }
    .btn-primary:hover { background: #000; }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-ghost { background: transparent; color: #6b7280; padding-inline: 0.4rem; box-shadow: none; }

    .pill { background: #f9fafb; border-radius: 999px; padding: 0.15rem 0.7rem; font-size: 0.75rem; color: #6b7280; }

    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead { background: #f9fafb; position: sticky; top: 0; z-index: 1; }
    th, td { padding: 0.4rem 0.35rem; border-bottom: 1px solid #f1f1f1; text-align: left; vertical-align: top; }
    th { font-weight: 600; font-size: 0.75rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.03em; }
    tbody tr:hover { background: #f9fafb; }

    input[type="text"], input[type="number"], textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 0.35rem 0.6rem;
      font-size: 0.85rem;
      outline: none;
      background: #fff;
    }
    input[type="number"] { max-width: 80px; border-radius: 999px; padding: 0.25rem 0.6rem; font-size: 0.8rem; }
    input:focus, textarea:focus { border-color: #111827; }

    /* ‚úÖ Producto como textarea auto-expansible */
    .name-textarea {
      border-radius: 14px;
      resize: none;           /* no permitir arrastrar para cambiar tama√±o */
      overflow: hidden;       /* sin scroll interno */
      line-height: 1.2;
      min-height: 34px;       /* 1 l√≠nea aprox */
    }

    .table-wrapper {
      max-height: 380px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #f1f1f1;
      background: #fff;
    }

    .badge-low {
      display: inline-flex; align-items: center; gap: 0.25rem;
      padding: 0.1rem 0.6rem; border-radius: 999px;
      background: #fef3c7; color: #92400e;
      font-size: 0.72rem; font-weight: 500;
    }
    .badge-ok {
      display: inline-flex; align-items: center; gap: 0.25rem;
      padding: 0.1rem 0.6rem; border-radius: 999px;
      background: #ecfdf5; color: #166534;
      font-size: 0.72rem; font-weight: 500;
    }
    .badge-pending {
      display: inline-flex; align-items: center; gap: 0.25rem;
      padding: 0.1rem 0.6rem; border-radius: 999px;
      background: #fee2e2; color: #b91c1c;
      font-size: 0.72rem; font-weight: 500;
    }
    .row-pending { background: #fff7ed !important; }

    .generated-card {
      margin-top: 1rem;
      background: #fff;
      border-radius: 16px;
      padding: 0.9rem;
      border: 1px solid #ececec;
      box-shadow: 0 6px 18px rgba(0,0,0,0.02);
    }

    .generated-header {
      display: flex; align-items: center; justify-content: space-between;
      gap: 0.5rem; margin-bottom: 0.5rem;
    }
    .generated-title { font-size: 0.95rem; font-weight: 600; }
    .hint { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }

    textarea#pedido-texto {
      min-height: 140px;
      border-radius: 12px;
      padding: 0.6rem 0.7rem;
      font-size: 0.85rem;
      resize: vertical;
    }

    .status-row {
      display: flex; align-items: center; gap: 0.3rem;
      font-size: 0.75rem; color: #6b7280; margin-top: 0.4rem;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 999px; background: #22c55e; }
    .status-dot.empty { background: #f97316; }

    .empty-message { font-size: 0.8rem; color: #9ca3af; text-align: center; padding: 0.8rem 0.4rem; }

    .actions { display: flex; gap: 0.15rem; justify-content: flex-end; align-items: center; }
    .icon-btn { border-radius: 10px; padding: 0.2rem 0.4rem; font-size: 0.85rem; line-height: 1; }
    .icon-btn:disabled { opacity: 0.35; cursor: not-allowed; }

    @media (max-width: 640px) {
      .app { padding-inline: 0.8rem; }
      h1 { font-size: 1.3rem; }
      .toolbar { align-items: flex-start; }

      /* ocultar categor√≠a en m√≥vil */
      th:nth-child(1), td:nth-child(1) { display: none; }
      input[type="number"] { max-width: 70px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <h1>Pedido Esencia</h1>
      <p class="subtitle">Actualiza stock actual, pulsa <strong>‚ÄúCalcular pedido‚Äù</strong> y copia el texto.</p>
    </header>

    <div class="card">
      <div class="toolbar">
        <div class="toolbar-left">
          <button class="btn-primary" id="btn-calcular">üßÆ Calcular pedido</button>
          <button class="btn-secondary" id="btn-add">‚ûï A√±adir producto</button>
          <span class="pill" id="pill-summary">0 productos</span>
        </div>
        <div class="toolbar-right">
          <button class="btn-ghost" id="btn-export">üíæ Guardar config</button>
          <button class="btn-ghost" id="btn-import">üìÇ Cargar config</button>
          <button class="btn-ghost" id="btn-reset">üóë Limpiar todo</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="min-width:120px;">Categor√≠a</th>
              <th style="min-width:260px;">Producto</th>
              <th style="min-width:120px;">Unidad</th>
              <th style="min-width:105px;">Stock actual</th>
              <th style="min-width:115px;">Stock m√°ximo</th>
              <th style="min-width:130px;">Estado</th>
              <th style="min-width:90px; text-align:right;">Orden</th>
              <th style="min-width:60px; text-align:right;">Del</th>
            </tr>
          </thead>
          <tbody id="product-body"></tbody>
        </table>
      </div>

      <div id="empty-message" class="empty-message" style="display:none;">
        No hay productos a√∫n. Pulsa <strong>‚ÄúA√±adir producto‚Äù</strong> para empezar.
      </div>
    </div>

    <div class="generated-card">
      <div class="generated-header">
        <div>
          <div class="generated-title">Texto de pedido para enviar</div>
          <div class="hint">Puedes editarlo y luego copiarlo a WhatsApp, Telegram, email, etc.</div>
        </div>
        <button class="btn-secondary" id="btn-copy">üìã Copiar texto</button>
      </div>

      <textarea id="pedido-texto" placeholder="Pulsa ‚ÄúCalcular pedido‚Äù para generar el texto."></textarea>

      <div class="status-row">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Sin calcular todav√≠a.</span>
      </div>
    </div>
  </div>

  <script>
    const DEFAULT_PRODUCTS = [
      { id: crypto.randomUUID?.() ?? String(Date.now())+"-1", categoria: "Siropes", nombre: "Sirope Monin Pistacho", unidad: "botella", stockActual: 0, stockMax: 1 },
      { id: crypto.randomUUID?.() ?? String(Date.now())+"-2", categoria: "Siropes", nombre: "Sirope Monin Vainilla", unidad: "botella", stockActual: 1, stockMax: 1 },
      { id: crypto.randomUUID?.() ?? String(Date.now())+"-3", categoria: "L√°cteos", nombre: "Leche entera", unidad: "caja 12 u", stockActual: 1, stockMax: 3 },
    ];

    const STORAGE_KEY = "esencia-pedido-productos-v3";
    let products = [];
    let sessionTouchedIds = new Set();

    function loadProducts() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          products = DEFAULT_PRODUCTS;
          saveProducts();
        } else {
          const parsed = JSON.parse(raw);
          products = Array.isArray(parsed) ? parsed : DEFAULT_PRODUCTS;
        }
      } catch {
        products = DEFAULT_PRODUCTS;
      }
      sessionTouchedIds = new Set(); // al entrar: todo pendiente
    }

    function saveProducts() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
      updateSummaryPill();
    }

    function swap(i, j) {
      const tmp = products[i];
      products[i] = products[j];
      products[j] = tmp;
      saveProducts();
      renderTable();
    }

    // ‚úÖ auto-resize del textarea (Producto)
    function autoResizeTextarea(el) {
      el.style.height = "auto";
      el.style.height = (el.scrollHeight) + "px";
    }

    function renderTable() {
      const tbody = document.getElementById("product-body");
      tbody.innerHTML = "";
      document.getElementById("empty-message").style.display = products.length === 0 ? "block" : "none";

      products.forEach((prod, index) => {
        const tr = document.createElement("tr");

        // Categor√≠a
        const tdCat = document.createElement("td");
        const inCat = document.createElement("input");
        inCat.type = "text";
        inCat.value = prod.categoria || "";
        inCat.placeholder = "Ej: Siropes";
        inCat.addEventListener("input", () => { prod.categoria = inCat.value; saveProducts(); });
        tdCat.appendChild(inCat);
        tr.appendChild(tdCat);

        // Producto (textarea auto-expansible)
        const tdNom = document.createElement("td");
        const taNom = document.createElement("textarea");
        taNom.className = "name-textarea";
        taNom.rows = 1;
        taNom.value = prod.nombre || "";
        taNom.placeholder = "Ej: Sirope Monin Pistacho";
        taNom.addEventListener("input", () => {
          prod.nombre = taNom.value;
          autoResizeTextarea(taNom);
          saveProducts();
        });
        // ajustar alto al render
        requestAnimationFrame(() => autoResizeTextarea(taNom));

        tdNom.appendChild(taNom);
        tr.appendChild(tdNom);

        // Unidad
        const tdUni = document.createElement("td");
        const inUni = document.createElement("input");
        inUni.type = "text";
        inUni.value = prod.unidad || "";
        inUni.placeholder = "Ej: botella";
        inUni.addEventListener("input", () => { prod.unidad = inUni.value; saveProducts(); });
        tdUni.appendChild(inUni);
        tr.appendChild(tdUni);

        // Stock actual
        const tdSA = document.createElement("td");
        const inSA = document.createElement("input");
        inSA.type = "number";
        inSA.min = "0";
        inSA.value = prod.stockActual ?? 0;
        inSA.addEventListener("input", () => {
          prod.stockActual = parseFloat(inSA.value || "0");
          sessionTouchedIds.add(prod.id);
          updateRowStatus(tr, prod);
          saveProducts();
        });
        tdSA.appendChild(inSA);
        tr.appendChild(tdSA);

        // Stock m√°ximo
        const tdSM = document.createElement("td");
        const inSM = document.createElement("input");
        inSM.type = "number";
        inSM.min = "0";
        inSM.value = prod.stockMax ?? 0;
        inSM.addEventListener("input", () => {
          prod.stockMax = parseFloat(inSM.value || "0");
          updateRowStatus(tr, prod);
          saveProducts();
        });
        tdSM.appendChild(inSM);
        tr.appendChild(tdSM);

        // Estado
        const tdEst = document.createElement("td");
        tr.appendChild(tdEst);

        // Orden
        const tdOrder = document.createElement("td");
        tdOrder.style.textAlign = "right";
        const box = document.createElement("div");
        box.className = "actions";

        const btnUp = document.createElement("button");
        btnUp.className = "btn-ghost icon-btn";
        btnUp.textContent = "‚¨ÜÔ∏è";
        btnUp.title = "Subir";
        btnUp.disabled = index === 0;
        btnUp.addEventListener("click", () => swap(index, index - 1));

        const btnDown = document.createElement("button");
        btnDown.className = "btn-ghost icon-btn";
        btnDown.textContent = "‚¨áÔ∏è";
        btnDown.title = "Bajar";
        btnDown.disabled = index === products.length - 1;
        btnDown.addEventListener("click", () => swap(index, index + 1));

        box.appendChild(btnUp);
        box.appendChild(btnDown);
        tdOrder.appendChild(box);
        tr.appendChild(tdOrder);

        // Del
        const tdDel = document.createElement("td");
        tdDel.style.textAlign = "right";
        const btnDel = document.createElement("button");
        btnDel.className = "btn-ghost icon-btn";
        btnDel.textContent = "‚úñ";
        btnDel.title = "Eliminar";
        btnDel.addEventListener("click", () => {
          products = products.filter(p => p.id !== prod.id);
          saveProducts();
          renderTable();
        });
        tdDel.appendChild(btnDel);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
        updateRowStatus(tr, prod);
      });

      updateSummaryPill();
    }

    function updateRowStatus(tr, prod) {
      const tdEst = tr.children[5];
      tdEst.innerHTML = "";

      if (!sessionTouchedIds.has(prod.id)) tr.classList.add("row-pending");
      else tr.classList.remove("row-pending");

      if (!prod.nombre) return;

      if (!sessionTouchedIds.has(prod.id)) {
        const b = document.createElement("span");
        b.className = "badge-pending";
        b.textContent = "Pendiente revisar";
        tdEst.appendChild(b);
        updateSummaryPill();
        return;
      }

      const sa = Number(prod.stockActual || 0);
      const sm = Number(prod.stockMax || 0);

      if (sm <= 0) {
        const b = document.createElement("span");
        b.className = "badge-low";
        b.textContent = "Sin stock m√°ximo";
        tdEst.appendChild(b);
        updateSummaryPill();
        return;
      }

      const diff = sm - sa;
      if (diff <= 0) {
        const b = document.createElement("span");
        b.className = "badge-ok";
        b.textContent = "OK";
        tdEst.appendChild(b);
      } else {
        const b = document.createElement("span");
        b.className = "badge-low";
        b.textContent = "Pedir";
        tdEst.appendChild(b);
      }

      updateSummaryPill();
    }

    function updateSummaryPill() {
      const pill = document.getElementById("pill-summary");
      const count = products.length;
      const pendientes = products.filter(p => !sessionTouchedIds.has(p.id)).length;

      let texto = count === 1 ? "1 producto" : `${count} productos`;
      if (count > 0) {
        texto += pendientes > 0
          ? ` ¬∑ ${pendientes} pendiente${pendientes === 1 ? "" : "s"}`
          : " ¬∑ todo revisado";
      }
      pill.textContent = texto;
    }

    function calcularPedidoTexto() {
      const lineas = [];
      let total = 0;

      products.forEach((p) => {
        if (!p.nombre) return;
        const sa = Number(p.stockActual || 0);
        const sm = Number(p.stockMax || 0);
        if (sm <= 0) return;

        const comprar = Math.max(0, sm - sa);
        if (comprar <= 0) return;

        total++;
        let linea = `- ${p.nombre} ‚Äì ${comprar} ${p.unidad || ""}`.trim();
        if (p.categoria) linea += ` (${p.categoria})`;
        lineas.push(linea);
      });

      const ta = document.getElementById("pedido-texto");
      const dot = document.getElementById("status-dot");
      const st = document.getElementById("status-text");

      if (lineas.length === 0) {
        ta.value = "Con el stock actual no hace falta comprar nada üôå";
        dot.classList.add("empty");
        st.textContent = "Sin productos para pedir.";
        return;
      }

      ta.value =
        "Hola, te paso el pedido de Esencia:\n\n" +
        lineas.join("\n") +
        "\n\nRev√≠salo y si ves algo raro me dices.";

      dot.classList.remove("empty");
      st.textContent = `Pedido calculado: ${total} l√≠neas.`;
    }

    async function copiarTexto() {
      const ta = document.getElementById("pedido-texto");
      const texto = ta.value.trim();
      if (!texto) return;

      try {
        await navigator.clipboard.writeText(texto);
        alert("Texto copiado ‚úÖ");
      } catch {
        ta.select();
        document.execCommand("copy");
        alert("Texto copiado ‚úÖ");
      }
    }

    async function exportConfig() {
      const data = JSON.stringify(products, null, 2);
      try {
        await navigator.clipboard.writeText(data);
        alert("Configuraci√≥n copiada. P√©gala en el otro dispositivo y usa ‚ÄúCargar config‚Äù.");
      } catch {
        alert("No se pudo copiar. Aqu√≠ tienes el JSON:\n\n" + data);
      }
    }

    function importConfig() {
      const raw = prompt("Pega aqu√≠ la configuraci√≥n (JSON):");
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return alert("Formato no v√°lido.");
        products = parsed;
        sessionTouchedIds = new Set();
        saveProducts();
        renderTable();
        alert("Configuraci√≥n importada ‚úÖ");
      } catch {
        alert("JSON inv√°lido o incompleto.");
      }
    }

    function addProduct() {
      products.push({
        id: crypto.randomUUID?.() ?? String(Date.now()) + "-" + Math.random(),
        categoria: "",
        nombre: "",
        unidad: "",
        stockActual: 0,
        stockMax: 0
      });
      saveProducts();
      renderTable();
    }

    function resetAll() {
      if (!confirm("Esto borra todos los productos guardados en este navegador. ¬øSeguro?")) return;
      products = [];
      sessionTouchedIds = new Set();
      saveProducts();
      renderTable();
      document.getElementById("pedido-texto").value = "";
      document.getElementById("status-dot").classList.add("empty");
      document.getElementById("status-text").textContent = "Datos reiniciados.";
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadProducts();
      renderTable();
      document.getElementById("btn-calcular").addEventListener("click", calcularPedidoTexto);
      document.getElementById("btn-copy").addEventListener("click", copiarTexto);
      document.getElementById("btn-add").addEventListener("click", addProduct);
      document.getElementById("btn-reset").addEventListener("click", resetAll);
      document.getElementById("btn-export").addEventListener("click", exportConfig);
      document.getElementById("btn-import").addEventListener("click", importConfig);
    });
  </script>
</body>
</html>
